name: Build Android APK

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  build:
    runs-on: ubuntu-20.04  # ë” ì•ˆì •ì ì¸ ë²„ì „ ì‚¬ìš©
    timeout-minutes: 60    # íƒ€ì„ì•„ì›ƒ ì„¤ì •
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'  # Buildozerì™€ ë” í˜¸í™˜ì„±ì´ ì¢‹ì€ ë²„ì „
        
    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          git zip unzip openjdk-8-jdk python3-pip autoconf libtool \
          pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev \
          libtinfo5 cmake libffi-dev libssl-dev build-essential \
          libltdl-dev ccache libffi6
          
    - name: Setup Java 8 (Buildozer í˜¸í™˜ì„±)
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '8'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip wheel setuptools
        pip install buildozer==1.4.0 cython==0.29.33
        
    - name: Cache Buildozer global directory
      uses: actions/cache@v3
      with:
        path: .buildozer_global
        key: buildozer-global-${{ hashFiles('buildozer.spec') }}-v2
        restore-keys: |
          buildozer-global-
        
    - name: Cache Buildozer directory
      uses: actions/cache@v3
      with:
        path: .buildozer
        key: buildozer-${{ hashFiles('buildozer.spec') }}-v2
        restore-keys: |
          buildozer-
          
    - name: Verify files
      run: |
        echo "=== íŒŒì¼ ëª©ë¡ ==="
        ls -la
        echo "=== main.py í™•ì¸ ==="
        head -10 main.py
        echo "=== buildozer.spec í™•ì¸ ==="
        head -20 buildozer.spec
        
    - name: Build Android APK
      run: |
        echo "=== Buildozer ë²„ì „ í™•ì¸ ==="
        buildozer --version
        
        echo "=== Android ë””ë²„ê·¸ APK ë¹Œë“œ ì‹œì‘ ==="
        buildozer android debug
        
        echo "=== ë¹Œë“œ ê²°ê³¼ í™•ì¸ ==="
        ls -la bin/ || echo "bin ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
        
    - name: Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: finance-app-debug
        path: bin/*.apk
        retention-days: 30
        
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: build-logs
        path: |
          .buildozer/android/platform/build-*/logs/
          .buildozer/android/logs/
        retention-days: 7
        
    - name: Create Release (íƒœê·¸ê°€ ìˆëŠ” ê²½ìš°)
      if: startsWith(github.ref, 'refs/tags/') && success()
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
        name: Release ${{ github.ref_name }}
        body: |
          ## ê¸ˆìœµë¶„ì„ë„êµ¬ v${{ github.ref_name }}
          
          ### ë‹¤ìš´ë¡œë“œ
          - Android APK íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì„¤ì¹˜í•˜ì„¸ìš”
          
          ### ì„¤ì¹˜ ë°©ë²•
          1. ì•ˆë“œë¡œì´ë“œ ê¸°ê¸°ì—ì„œ "ì•Œ ìˆ˜ ì—†ëŠ” ì†ŒìŠ¤" í—ˆìš©
          2. APK íŒŒì¼ ë‹¤ìš´ë¡œë“œ í›„ ì„¤ì¹˜
          
          ### ì£¼ìš” ê¸°ëŠ¥
          - ğŸ“Š TradingView ìµœê³  ìˆœì´ìµ ì£¼ì‹
          - ğŸ“ˆ S&P500 ì´ìµìˆ˜ìµë¥  ë¶„ì„
          - ğŸ’° M2 í†µí™”ëŸ‰ ëª¨ë‹ˆí„°ë§
          - ğŸ’± USD/JPY í™˜ìœ¨ ì¶”ì 
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}